name: Build Jar and DEB 

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch: # ---> Para ejecutar desde la interfaz 

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - uses: gradle/actions/setup-gradle@v4

      - name: Build with Gradle
        run: ./gradlew fatJar --no-daemon # --> Evitar algunos errores  CI 
      
      - name: Install dependencies for DEB packaging
        run: |
          sudo apt-get update
          sudo apt-get install -y dh-make debhelper devscripts
          
      - name: Create DEB package structure
        run: |
          mkdir -p deb-package/usr/share/apkeditor
          mkdir -p deb-package/usr/bin
          mkdir -p deb-package/DEBIAN
          chmod 755 deb-package 

          # Copy the built jar
          cp build/libs/*.jar deb-package/usr/share/apkeditor/apkeditor.jar
          
          # Create launcher script
          echo '#!/bin/sh' > deb-package/usr/bin/apkeditor
          echo 'java -jar /usr/share/apkeditor/apkeditor.jar "$@"' >> deb-package/usr/bin/apkeditor
          chmod +x deb-package/usr/bin/apkeditor
          
          # Create control file
          cat > deb-package/DEBIAN/control <<EOL
          Package: apkeditor
          Version: 1.4-${{ github.run_number }}
          Section: utils
          Priority: optional
          Architecture: all
          Maintainer: @demonr_rip <your.email@example.com>
          Description: APK Editor tool
           A tool for editing APK files.
          EOL
          
      - name: Build DEB package
        run: |
          dpkg-deb --build deb-package
          mkdir -p artifacts
          mv deb-package.deb artifacts/apkeditor_1.0-${{ github.run_number }}_all.deb 
           
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-Outputs-${{ github.run_id }}
          path: |
            build/libs/*.jar
            artifacts/*.deb
      
